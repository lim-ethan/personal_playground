# Kafka 실습 & 주요 명령어 심화 학습

## 1. Kafka 설치 및 실행 (단일 브로커)
### 1.1 다운로드 및 압축 해제
```bash
# Kafka 다운로드
wget https://downloads.apache.org/kafka/3.8.0/kafka_2.13-3.8.0.tgz

# 압축 해제
tar -xvzf kafka_2.13-3.8.0.tgz
cd kafka_2.13-3.8.0
```

### 1.2 Zookeeper & Kafka 브로커 실행

```bash
# Zookeeper 실행
bin/zookeeper-server-start.sh config/zookeeper.properties

# Kafka 브로커 실행
bin/kafka-server-start.sh config/server.properties
```

---

## 2. 토픽 생성 / 조회 / 삭제

```bash
# 토픽 생성 (replication.factor=1, partitions=1)
bin/kafka-topics.sh --create \
  --topic test-topic \
  --bootstrap-server localhost:9092 \
  --partitions 1 \
  --replication-factor 1

# 토픽 목록 확인
bin/kafka-topics.sh --list --bootstrap-server localhost:9092

# 토픽 상세 정보 확인
bin/kafka-topics.sh --describe --topic test-topic --bootstrap-server localhost:9092

# 토픽 삭제
bin/kafka-topics.sh --delete --topic test-topic --bootstrap-server localhost:9092
```

---

## 3. 메시지 Produce / Consume
```bash
# Producer 실행 (CLI)
bin/kafka-console-producer.sh \
  --topic test-topic \
  --bootstrap-server localhost:9092

# Consumer 실행 (CLI)
bin/kafka-console-consumer.sh \
  --topic test-topic \
  --from-beginning \
  --bootstrap-server localhost:9092
```

---


## 4. 주요 파라미터 실습
### 4.1 acks
- acks=0 : Producer가 전송 후 응답을 기다리지 않음 (최고속도, 낮은 안정성)
- acks=1 : Leader 브로커가 메시지 기록 후 응답 (기본값)
- acks=all : Leader + 모든 ISR(복제 브로커)이 기록 완료 후 응답 (가장 안전)

```bash
bin/kafka-console-producer.sh \
  --topic test-topic \
  --bootstrap-server localhost:9092 \
  --producer-property acks=all
```

### 4.2 replication.factor
- 복제본 개수 지정 (단일 브로커에서는 1만 가능)
- 예: replication.factor=3 → 브로커 3개 필요

### 4.3 retention.ms
- 메시지 보관 시간 (기본: 7일)
- 실습: 1분 후 삭제

```bash
bin/kafka-configs.sh --alter \
  --bootstrap-server localhost:9092 \
  --entity-type topics \
  --entity-name test-topic \
  --add-config retention.ms=60000

```
---

## 5. Consumer Group 동작 원리 실습
### 5.1 Consumer Group 생성 & 메시지 분배 확인

```
# Consumer 1 (Group: my-group)
bin/kafka-console-consumer.sh \
  --topic test-topic \
  --bootstrap-server localhost:9092 \
  --group my-group

# Consumer 2 (Group: my-group)
bin/kafka-console-consumer.sh \
  --topic test-topic \
  --bootstrap-server localhost:9092 \
  --group my-group
```
- 원리: 같은 Group ID를 사용하면 파티션이 Consumer 간 분배됨.

---

6. Python Producer / Consumer 예제
```python
# producer.py
from kafka import KafkaProducer
producer = KafkaProducer(bootstrap_servers='localhost:9092')

for i in range(5):
    producer.send('test-topic', f"message {i}".encode('utf-8'))

producer.flush() 
# flush() 함수 수행 전까지 for문에서 전송할 메세지를 미리 버퍼에 적재
# flush() 함수 실행 시 메세지를 토픽으로 전송하고, 응답을 받을 때까지 대기

# consumer.py
from kafka import KafkaConsumer
consumer = KafkaConsumer(
    'test-topic',
    bootstrap_servers='localhost:9092',
    auto_offset_reset='earliest',
    group_id='my-group'
)

for message in consumer:
    print(f"{message.topic}:{message.partition}:{message.offset} key={message.key} value={message.value}")

```